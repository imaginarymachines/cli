{"version":3,"sources":["../../src/lib/config.js"],"sourcesContent":["const fs = require('fs');\nlet pluginMachineJson = false;\nconst { join } = require( 'path' );\nconst { homedir } = require( 'os' );\n\n//Get current pluginMachine.json file\n const getPluginMachineJson = (pluginDir, opts = {} ) => {\n    if( ! pluginMachineJson ){\n      if(  fs.existsSync(`${pluginDir}/pluginMachine.json`) ){\n        pluginMachineJson = require(\n            join(pluginDir, 'pluginMachine.json')\n        );\n      }else{\n        pluginMachineJson = {pluginId: 0, buildId: 0};\n      }\n    }\n\n    pluginMachineJson = Object.assign(pluginMachineJson, opts);\n    pluginMachineJson.pluginId = parseInt(pluginMachineJson.pluginId, 10);\n    pluginMachineJson.buildId = parseInt(pluginMachineJson.buildId, 10);\n    if( ! pluginMachineJson.hasOwnProperty('appUrl')|| false == pluginMachineJson.appUrl ){\n      pluginMachineJson.appUrl = 'https://pluginmachine.app';\n    }\n\n    return pluginMachineJson;\n}\n\n//Get auth token from auth.json, if set\n const getAuthToken = () => {\n  const authConfig = getAuthConfig();\n  if( authConfig.hasOwnProperty('token') ){\n    return authConfig.token;\n  }\n  return false;\n};\n\n const getPluginDir = () => {\n  const {cwd}= require( 'process');\n  return cwd();\n}\n//update auth.json contents\n const updateAuthConfig = (newData) => {\n    // read existing config\n    const currentData = readAuthConfigFile();\n    if( ! currentData ){\n        writeToAuthConfigFile(newData);\n    }else{\n        writeToAuthConfigFile({\n            ...currentData,\n            ...newData\n        });\n    }\n    return getAuthConfig();\n};\n\n//Get auth.json contantes\n const getAuthConfig = () => {\n    const config = readAuthConfigFile();\n    return config ? config : {};\n}\n\n\n// Path to auth.json\nconst AUTH_CONFIG_FILE_PATH = `${homedir()}/.plugin-machine-php-cli/auth.json`;\n\n// reads \"auth config\" file atomically\n// @see https://github.com/vercel/vercel/blob/f18bca97187d17c050695a7a348b8ae02c244ce9/packages/cli/src/util/config/files.ts#L53-L57\nconst readAuthConfigFile = () => {\n  if( ! fs.existsSync(AUTH_CONFIG_FILE_PATH) ){\n    return false;\n  }\n  try {\n    const config = fs.readFileSync(AUTH_CONFIG_FILE_PATH);\n    return JSON.parse(config);\n  return config;\n  } catch (error) {\n    return false;\n  }\n\n};\n\n//Placeholder error handler\nconst error = (message) => message;\n\n//Write to auth.json\n//@see https://github.com/vercel/vercel/blob/f18bca97187d17c050695a7a348b8ae02c244ce9/packages/cli/src/util/config/files.ts#L59-L91\nconst writeToAuthConfigFile = (authConfig) => {\n    if (authConfig.skipWrite) {\n      return;\n    }\n    try {\n      return fs.writeFileSync(AUTH_CONFIG_FILE_PATH,\n        JSON.stringify(authConfig), {\n        flags: 'w+',\n      });\n    } catch (err) {\n      if (err.code === 'EPERM') {\n        console.error(\n          error(\n            `Not able to create ${highlight(\n              AUTH_CONFIG_FILE_PATH\n            )} (operation not permitted).`\n          )\n        );\n        process.exit(1);\n      } else if (err.code === 'EBADF') {\n        console.error(\n          error(\n            `Not able to create ${highlight(\n              AUTH_CONFIG_FILE_PATH\n            )} (bad file descriptor).`\n          )\n        );\n        process.exit(1);\n      }\n\n      throw err;\n    }\n  };\n\n\n// Returns whether a directory exists\nconst isDirectory = (path) => {\n    try {\n        return fs.lstatSync(path).isDirectory();\n    } catch (_) {\n        // We don't care which kind of error occured, it isn't a directory anyway.\n        return false;\n    }\n};\n\n// Returns full URL for endpoint on Plugin Machine server.\n// Override\n// `getPluginMachineJson(pluginDir, {appUrl: 'http://localhost:3000'})`\nconst appUrl = (endpoint) => `${getPluginMachineJson().appUrl}${endpoint}`;\n\n// Retruns full URL for endpoint on Plugin Machine server, with current api prefix\nconst apiUrl = (endpoint) => `${appUrl(`/api/v1${endpoint}`)}`;\n\nmodule.exports = {\n  getPluginMachineJson,\n  getAuthToken,\n  getPluginDir,\n  updateAuthConfig,\n  getAuthConfig,\n  readAuthConfigFile,\n  writeToAuthConfigFile,\n  isDirectory,\n  appUrl,\n  apiUrl\n}\n"],"names":["fs","require","pluginMachineJson","join","homedir","getPluginMachineJson","pluginDir","opts","existsSync","pluginId","buildId","Object","assign","parseInt","hasOwnProperty","appUrl","getAuthToken","authConfig","getAuthConfig","token","getPluginDir","cwd","updateAuthConfig","newData","currentData","readAuthConfigFile","writeToAuthConfigFile","config","AUTH_CONFIG_FILE_PATH","readFileSync","JSON","parse","error","message","skipWrite","writeFileSync","stringify","flags","err","code","console","highlight","process","exit","isDirectory","path","lstatSync","_","endpoint","apiUrl","module","exports"],"mappings":"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"}